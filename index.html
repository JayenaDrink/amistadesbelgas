<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Amistades Belgas — Pedido</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#f8fafc; --text:#0f172a; --muted:#6b7280; --accent:#0ea5e9;
      --panel:#ffffff; --brd:#e5e7eb; --brd2:#d1d5db; --hover:#f1f5f9;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220; --text:#e5e7eb; --muted:#9aa3af; --accent:#38bdf8;
        --panel:#0f172a; --brd:#1f2737; --brd2:#263043; --hover:#121c2c;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
    body{background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .toolbar{display:flex;gap:10px;align-items:center}
    label{font-size:13px;color:var(--muted)}
    input,select,button{border:1px solid var(--brd2);background:var(--panel);color:var(--text);border-radius:8px;padding:8px 10px;font-size:14px}
    button{cursor:pointer}
    .badge{font-size:12px;padding:4px 8px;border:1px dashed var(--brd2);border-radius:999px;color:var(--muted)}
    .sheet{background:var(--panel);border:1px solid var(--brd2);border-radius:10px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    thead th{background:var(--bg);font-weight:600;color:var(--muted);text-align:left;border-bottom:1px solid var(--brd2);padding:10px}
    tbody td{border-bottom:1px solid var(--brd);padding:8px 10px}
    tbody tr:hover{background:var(--hover)}
    .col-name{width:50%}
    .col-price{width:15%}
    .col-qty{width:20%}
    .col-sub{width:15%;text-align:right}
    .qty-wrap{display:flex;gap:8px;align-items:center}
    .btn-circle{width:32px;height:32px;border-radius:6px;display:grid;place-items:center;font-size:18px}
    .qty-input{width:64px;text-align:center}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:12px}
    .total-box{border:1px solid var(--brd2);border-radius:10px;padding:10px 12px;min-width:220px;background:var(--panel);text-align:right}
    .muted{color:var(--muted)}
    .error{color:#b91c1c;font-size:13px;margin-top:6px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="t-title">Amistades Belgas — Pedido</h1>
      <div class="toolbar">
        <label for="langSel" id="t-language">Idioma</label>
        <select id="langSel" aria-label="Idioma">
          <option value="fr">FR</option>
          <option value="nl">NL</option>
          <option value="en">EN</option>
          <option value="es" selected>ES</option>
        </select>
      </div>
    </header>

    <div class="toolbar" style="justify-content:space-between;margin-bottom:10px">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <div>
          <label for="nameInput" id="t-yourname">Tu nombre</label><br/>
          <input id="nameInput" type="text" placeholder="…" required/>
          <div id="nameErr" class="error">El nombre es obligatorio</div>
        </div>
      </div>
      <span class="badge" id="t-open-thu">Abierto los jueves</span>
    </div>

    <div class="sheet">
      <table>
        <thead>
          <tr>
            <th class="col-name" id="t-drink-col">Bebida</th>
            <th class="col-price" id="t-price-col">Precio</th>
            <th class="col-qty" id="t-qty-col">Cantidad</th>
            <th class="col-sub" id="t-sub-col">Subtotal</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="footer">
      <div>
        <button id="sendBtn">Enviar pedido</button>
        <button id="clearBtn">Borrar pedido</button>
        <div id="orderErr" class="error">Agrega al menos una bebida</div>
      </div>
      <div class="total-box">
        <div class="muted" id="t-total">Total</div>
        <div style="font-weight:700;font-size:18px"><span id="totalAmount">0,00</span> €</div>
      </div>
    </div>
  </div>

<!-- ======= FRONTEND (UI + lógica) ======= -->
<script>
const I18N = {
  es:{title:"Amistades Belgas — Pedido",language:"Idioma",yourname:"Tu nombre",
      drinkCol:"Bebida",priceCol:"Precio",qtyCol:"Cantidad",subCol:"Subtotal",
      total:"Total",send:"Enviar pedido",clear:"Borrar pedido",
      nameRequired:"El nombre es obligatorio",orderRequired:"Agrega al menos una bebida",
      openThu:"Abierto los jueves",currency:"€",
      sent:"Pedido enviado (ID: {id}).", sendErr:"No se pudo enviar el pedido. Reintenta."},
  fr:{title:"Amistades Belgas — Commande",language:"Langue",yourname:"Votre nom",
      drinkCol:"Boisson",priceCol:"Prix",qtyCol:"Quantité",subCol:"Sous-total",
      total:"Total",send:"Envoyer la commande",clear:"Effacer la commande",
      nameRequired:"Le nom est obligatoire",orderRequired:"Ajoutez au moins une boisson",
      openThu:"Ouvert le jeudi",currency:"€",
      sent:"Commande envoyée (ID : {id}).", sendErr:"Impossible d’envoyer la commande. Réessayez."},
  nl:{title:"Amistades Belgas — Bestelling",language:"Taal",yourname:"Je naam",
      drinkCol:"Drank",priceCol:"Prijs",qtyCol:"Aantal",subCol:"Subtotaal",
      total:"Totaal",send:"Bestelling verzenden",clear:"Bestelling wissen",
      nameRequired:"Naam is verplicht",orderRequired:"Voeg minstens één drankje toe",
      openThu:"Open op donderdag",currency:"€",
      sent:"Bestelling verzonden (ID: {id}).", sendErr:"Bestelling kon niet worden verzonden. Probeer opnieuw."},
  en:{title:"Amistades Belgas — Drinks Order",language:"Language",yourname:"Your name",
      drinkCol:"Drink",priceCol:"Price",qtyCol:"Qty",subCol:"Subtotal",
      total:"Total",send:"Send order",clear:"Clear order",
      nameRequired:"Name is required",orderRequired:"Add at least one drink",
      openThu:"Open on Thursdays",currency:"€",
      sent:"Order sent (ID: {id}).", sendErr:"Could not send order. Please try again."}
};

function detectLang(){
  const saved = localStorage.getItem('ab-lang');
  if(saved) return saved;
  const nav=(navigator.language||'').toLowerCase();
  if(nav.startsWith('fr')) return 'fr';
  if(nav.startsWith('nl')) return 'nl';
  if(nav.startsWith('en')) return 'en';
  return 'es';
}
const state = { lang: detectLang(), quantities:{} };
const t = k => I18N[state.lang][k]||k;
const langSel = document.getElementById('langSel');

const DRINKS = [
  { id:'agua',        price:1.00, label:{es:'Agua sin gas', fr:'Eau plate', nl:'Plat water', en:'Still water'} },
  { id:'aguaGas',     price:1.00, label:{es:'Agua con gas', fr:'Eau gazeuse', nl:'Spuitwater', en:'Sparkling water'} },
  { id:'coca',        price:1.50, label:{es:'Coca Cola', fr:'Coca-Cola', nl:'Coca-Cola', en:'Coca-Cola'} },
  { id:'cocaz',       price:1.50, label:{es:'Coca Cola Zero', fr:'Coca-Cola Zéro', nl:'Coca-Cola Zero', en:'Coke Zero'} },
  { id:'fantaN',      price:1.50, label:{es:'Fanta Naranja', fr:'Fanta Orange', nl:'Fanta Sinaas', en:'Fanta Orange'} },
  { id:'fantaL',      price:1.50, label:{es:'Fanta Limón', fr:'Fanta Citron', nl:'Fanta Citroen', en:'Fanta Lemon'} },
  { id:'nestea',      price:1.50, label:{es:'Nestea', fr:'Nestea', nl:'Nestea', en:'Nestea'} },
  { id:'tonica',      price:1.50, label:{es:'Tónica', fr:'Tonic', nl:'Tonic', en:'Tonic'} },
  { id:'bitter',      price:1.50, label:{es:'Bitter Kas', fr:'Bitter Kas', nl:'Bitter Kas', en:'Bitter Kas'} },
  { id:'cerveza',     price:1.50, label:{es:'Cerveza', fr:'Bière', nl:'Bier', en:'Beer'} },
  { id:'sinAlc',      price:1.50, label:{es:'Cerveza Sin Alcohol', fr:'Bière sans alcool', nl:'Alcoholvrij bier', en:'Alcohol-free beer'} },
  { id:'leffe',       price:2.50, label:{es:'Leffe bl', fr:'Leffe Blonde', nl:'Leffe Blond', en:'Leffe Blonde'} },
  { id:'duvel',       price:2.50, label:{es:'Duvel', fr:'Duvel', nl:'Duvel', en:'Duvel'} },
  { id:'omer',        price:2.50, label:{es:'Omer', fr:'Omer', nl:'Omer', en:'Omer'} },
  { id:'chimay',      price:3.00, label:{es:'Chimay Blauw', fr:'Chimay Bleue', nl:'Chimay Blauw', en:'Chimay Blue'} },
  { id:'kriek',       price:2.50, label:{es:'Kriek', fr:'Kriek', nl:'Kriek', en:'Kriek'} },
  { id:'vinoTinto',   price:7.50, label:{es:'Vino Tinto', fr:'Vin rouge', nl:'Rode wijn', en:'Red wine'} },
  { id:'vinoBlanco',  price:7.50, label:{es:'Vino blanco', fr:'Vin blanc', nl:'Witte wijn', en:'White wine'} },
  { id:'vinoRosado',  price:7.00, label:{es:'Vino Rosado', fr:'Vin rosé', nl:'Rosé wijn', en:'Rosé wine'} },
  { id:'botellaVino', price:9.00, label:{es:'Botella vino', fr:'Bouteille de vin', nl:'Fles wijn', en:'Bottle of wine'} },
  { id:'cavaPeq',     price:2.50, label:{es:'Cava pequeño', fr:'Cava petit', nl:'Kleine cava', en:'Small cava'} },
  { id:'cavaGrande',  price:11.00, label:{es:'Cava Grande', fr:'Cava grande', nl:'Grote cava', en:'Large cava'} },
  { id:'whisky',      price:2.50, label:{es:'Whisky', fr:'Whisky', nl:'Whisky', en:'Whisky'} },
  { id:'cognac',      price:2.50, label:{es:'Cognac', fr:'Cognac', nl:'Cognac', en:'Cognac'} },
  { id:'gin',         price:2.50, label:{es:'Gin', fr:'Gin', nl:'Gin', en:'Gin'} },
  { id:'vodka',       price:2.50, label:{es:'Vodka', fr:'Vodka', nl:'Wodka', en:'Vodka'} },
  { id:'cafe',        price:1.50, label:{es:'Café', fr:'Café', nl:'Koffie', en:'Coffee'} },
  { id:'te',          price:1.50, label:{es:'Té', fr:'Thé', nl:'Thee', en:'Tea'} },
  { id:'chupito',     price:1.00, label:{es:'Chupito', fr:'Shot', nl:'Shotje', en:'Shot'} }
];

const rowsEl = document.getElementById('rows');
const totalEl = document.getElementById('totalAmount');
const nameInput = document.getElementById('nameInput');
const nameErr = document.getElementById('nameErr');
const orderErr = document.getElementById('orderErr');

function locale(){ return state.lang==='nl'?'nl-NL':state.lang==='fr'?'fr-FR':state.lang==='en'?'en-GB':'es-ES'; }

// Identificador único por dispositivo (persistente)
const DEVICE_ID = (() => {
  let id = localStorage.getItem('ab-device-id');
  if (!id) { id = (crypto?.randomUUID?.() || String(Math.random()).slice(2)); localStorage.setItem('ab-device-id', id); }
  return id;
})();

function lineSubtotal(d){ return (state.quantities[d.id]||0) * d.price; }

function setQty(id, v){
  state.quantities[id]=v;
  const inp=document.getElementById('inp-'+id); if(inp) inp.value=v;
  const d = DRINKS.find(x=>x.id===id);
  const sub = document.getElementById('sub-'+id);
  if(sub && d) sub.textContent = `${lineSubtotal(d).toLocaleString(locale(),{minimumFractionDigits:2,maximumFractionDigits:2})} ${I18N[state.lang].currency}`;
  updateTotals();
}

function updateTotals(){
  const total = DRINKS.reduce((s,d)=> s + lineSubtotal(d), 0);
  totalEl.textContent = total.toLocaleString(locale(),{minimumFractionDigits:2,maximumFractionDigits:2});
}

function renderTable(){
  rowsEl.innerHTML = '';
  DRINKS.forEach(d=>{
    if(state.quantities[d.id]===undefined) state.quantities[d.id]=0;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-name">${d.label[state.lang]}</td>
      <td class="col-price">${d.price.toLocaleString(locale(),{minimumFractionDigits:2,maximumFractionDigits:2})} ${I18N[state.lang].currency}</td>
      <td class="col-qty">
        <div class="qty-wrap">
          <button class="btn-circle" data-id="${d.id}" data-delta="-1">−</button>
          <input class="qty-input" id="inp-${d.id}" type="number" min="0" value="${state.quantities[d.id]}"/>
          <button class="btn-circle" data-id="${d.id}" data-delta="1">+</button>
        </div>
      </td>
      <td class="col-sub" id="sub-${d.id}">${lineSubtotal(d).toLocaleString(locale(),{minimumFractionDigits:2,maximumFractionDigits:2})} ${I18N[state.lang].currency}</td>
    `;
    rowsEl.appendChild(tr);
  });
  rowsEl.querySelectorAll('.btn-circle').forEach(b=>{
    b.addEventListener('click', e=>{
      const id=e.currentTarget.dataset.id;
      const delta=parseInt(e.currentTarget.dataset.delta,10);
      setQty(id, Math.max(0,(state.quantities[id]||0)+delta));
    });
  });
  DRINKS.forEach(d=>{
    const inp=document.getElementById('inp-'+d.id);
    inp.addEventListener('change', ()=>{
      let v=parseInt(inp.value||'0',10); if(isNaN(v)||v<0) v=0;
      setQty(d.id, v);
    });
  });
  updateTotals();
}

function applyTexts(){
  document.getElementById('t-title').textContent = t('title');
  document.getElementById('t-language').textContent = t('language');
  document.getElementById('t-yourname').textContent = t('yourname');
  document.getElementById('t-open-thu').textContent = t('openThu');
  document.getElementById('t-drink-col').textContent = t('drinkCol');
  document.getElementById('t-price-col').textContent = t('priceCol');
  document.getElementById('t-qty-col').textContent   = t('qtyCol');
  document.getElementById('t-sub-col').textContent   = t('subCol');
  document.getElementById('t-total').textContent     = t('total');
  document.getElementById('sendBtn').textContent     = t('send');
  document.getElementById('clearBtn').textContent    = t('clear');
}

langSel.value = state.lang;
langSel.addEventListener('change', ()=>{
  state.lang = langSel.value;
  localStorage.setItem('ab-lang', state.lang);
  applyTexts();
  renderTable();
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  for(const k of Object.keys(state.quantities)) state.quantities[k]=0;
  renderTable();
  orderErr.style.display='none';
});

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const name=(nameInput.value||'').trim();
  const totalUnits = Object.values(state.quantities).reduce((a,b)=>a+(b||0),0);
  nameErr.style.display  = name ? 'none':'block';
  orderErr.style.display = totalUnits>0 ? 'none':'block';
  if(!name || totalUnits===0) return;

  const dayStr = new Date().toISOString().slice(0,10);
  const order = {
    name, lang: state.lang, createdAt: new Date().toISOString(),
    items: Object.fromEntries(DRINKS.filter(d=> (state.quantities[d.id]||0)>0)
             .map(d=>[d.id,{qty:state.quantities[d.id], price:d.price, label:d.label[state.lang]}])),
    total: DRINKS.reduce((s,d)=> s + (state.quantities[d.id]||0)*d.price, 0),
    deviceId: DEVICE_ID,
    day: dayStr
  };

  localStorage.setItem('ab-last-order', JSON.stringify(order));

  try {
    const docId = await (window.abSendOrder ? window.abSendOrder(order) : Promise.reject(new Error('Firestore no inicializado')));
    const msg = (I18N[state.lang].sent||'Pedido enviado (ID: {id}).').replace('{id}', docId);
    alert(msg);
    for(const k of Object.keys(state.quantities)) state.quantities[k]=0;
    renderTable();
  } catch(e) {
    console.error(e);
    alert(I18N[state.lang].sendErr||'No se pudo enviar el pedido. Reintenta.');
  }
});

applyTexts();
renderTable();
</script>

<!-- ======= FIREBASE (envío + watcher de alertas) ======= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAzb1g7DOGluAfcvyWushkkqcHawh2FHaM",
    authDomain: "amistades-belgas.firebaseapp.com",
    projectId: "amistades-belgas",
    storageBucket: "amistades-belgas.firebasestorage.app",
    messagingSenderId: "897458358699",
    appId: "1:897458358699:web:842a5f29287e230ab02aee"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // Enviar pedido a Firestore
  window.abSendOrder = async (order) => {
    const payload = {
      ...order,
      status: 'pending',
      createdAt: serverTimestamp(),
      day: order.day || new Date().toISOString().slice(0,10)
    };
    const ref = await addDoc(collection(db, 'orders'), payload);
    return ref.id;
  };

  // ===== ALERTA EN TIEMPO REAL (para ESTE dispositivo) =====
  const DEVICE_ID = localStorage.getItem('ab-device-id') || '';
  const alerted = new Set((JSON.parse(localStorage.getItem('ab-alerted')||'[]')));

  function rememberAlert(id){
    alerted.add(id);
    localStorage.setItem('ab-alerted', JSON.stringify(Array.from(alerted)));
  }

  async function ensureNotifPermission(){
    try{
      if ('Notification' in window && Notification.permission === 'default') {
        await Notification.requestPermission();
      }
    }catch(_){}
  }

  function showReadyAlert(docId, name){
    const msg = `¡Pedido listo para ${name||'tu mesa'}! (ID: ${docId})`;
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('Amistades Belgas', { body: msg });
    } else {
      alert(msg);
    }
    try {
      const beep = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAAACAgAA');
      beep.play().catch(()=>{});
    } catch(_){}
  }

  (async function startWatcher(){
    await ensureNotifPermission();
    const today = new Date().toISOString().slice(0,10);
    const q = query(
      collection(db,'orders'),
      where('day','==', today),
      where('deviceId','==', DEVICE_ID)
    );
    onSnapshot(q, (snap)=>{
      snap.docChanges().forEach(ch=>{
        const d = ch.doc.data();
        const id = ch.doc.id;
        if (d.status === 'completed' && !alerted.has(id)) {
          showReadyAlert(id, d.name);
          rememberAlert(id);
        }
      });
    });
  })();
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAzb1g7DOGluAfcvyWushkkqcHawh2FHaM",
    authDomain: "amistades-belgas.firebaseapp.com",
    projectId: "amistades-belgas",
    storageBucket: "amistades-belgas.firebasestorage.app",
    messagingSenderId: "897458358699",
    appId: "1:897458358699:web:842a5f29287e230ab02aee"
  };

  // IMPORTANTE: Reutiliza la app si ya está inicializada
  let app;
  try { app = initializeApp(firebaseConfig); } catch(e) { /* ignore if already */ }

  const db  = getFirestore();

  // Usa el mismo deviceId que ya generabas (o vuelve a generarlo si no existe)
  const DEVICE_ID = (() => {
    let id = localStorage.getItem('ab-device-id');
    if (!id) { id = (crypto?.randomUUID?.() || String(Math.random()).slice(2)); localStorage.setItem('ab-device-id', id); }
    return id;
  })();

  // Registra el SW para que FCM pueda enviar push
  async function registerSW() {
    if (!('serviceWorker' in navigator)) return null;
    // OJO con la ruta: debe coincidir con dónde está el archivo
    return await navigator.serviceWorker.register('/amistadesbelgas/firebase-messaging-sw.js');
  }

  async function ensureNotificationPermission(){
    if (!('Notification' in window)) return false;
    if (Notification.permission === 'granted') return true;
    if (Notification.permission === 'denied') return false;
    const res = await Notification.requestPermission();
    return res === 'granted';
  }

  async function setupFCM(){
    try{
      if (!await isSupported()) return; // Safari iOS antiguo, etc.
      const swReg = await registerSW();
      if (!swReg) return;

      const ok = await ensureNotificationPermission();
      if (!ok) return;

      const messaging = getMessaging();
      // REEMPLAZA por tu VAPID PÚBLICA
      const vapidKey = "YOUR_VAPID_PUBLIC_KEY_HERE";
      const token = await getToken(messaging, { vapidKey, serviceWorkerRegistration: swReg });

      if (token) {
        // Guardamos token en Firestore bajo deviceTokens/{deviceId}/tokens/{token}
        await setDoc(
          doc(db, 'deviceTokens', DEVICE_ID, 'tokens', token),
          { createdAt: serverTimestamp(), ua: navigator.userAgent },
          { merge: true }
        );
      }

      // (Opcional) Notificaciones en foreground
      onMessage(messaging, (payload)=>{
        // Muestra algo si la página está abierta (también llega la push del SW)
        console.log('Push recibida en foreground:', payload);
      });
    } catch(e){
      console.error('FCM setup error', e);
    }
  }

  // Arrancar FCM
  setupFCM();
</script>

</body>
</html>
